---
import PageLayout from '../../layouts/PageLayout.astro';
import ReleaseCard from '../../components/ReleaseCard.astro';
import DownloadGateModal from '../../components/DownloadGateModal.astro';
import { withBase } from '../../lib/paths';

const capabilityCards = [
  {
    icon: 'G',
    title: 'Granularny silnik wieloźródłowy',
    text: 'Ładowanie wielu plików WAV do wspólnego bufora i budowanie złożonych chmur ziaren w czasie rzeczywistym.',
    tags: ['Granular', 'WAV', 'Live']
  },
  {
    icon: 'P',
    title: 'Precyzyjna kontrola parametrów',
    text: 'Sterowanie czasem trwania ziaren, gęstością chmury, rozrzutem wysokości i głośności oraz obwiednią.',
    tags: ['Pitch', 'Gain', 'Envelope']
  },
  {
    icon: 'W',
    title: 'Workflow oparty o waveform',
    text: 'Selekcja, grupowanie i edycja zakresów próbkowania bezpośrednio na podglądzie fali.',
    tags: ['Waveform', 'Selection', 'Editing']
  },
  {
    icon: 'M',
    title: 'Rozszerzony routing kanałów',
    text: 'Panel multichannel z routingiem, mute/solo oraz parami panorama dla złożonych układów wyjściowych.',
    tags: ['Routing', 'Multichannel', 'Pan']
  },
  {
    icon: 'A',
    title: 'Audio Generator (AI)',
    text: 'Panel konwersacyjny wspierający generowanie materiału audio i szybkie iteracje wariantów brzmieniowych.',
    tags: ['Generator', 'Prompt', 'Session']
  }
];

const useCaseCards = [
  {
    icon: 'F',
    title: 'Tekstury filmowe i drony',
    text: 'Budowanie atmosfer i warstw tła o ciągłej, ewoluującej strukturze.',
    tags: ['Cinematic', 'Ambient']
  },
  {
    icon: 'R',
    title: 'Rytmiczne glitche',
    text: 'Dekonstrukcja i ponowne składanie materiału perkusyjnego w nieregularne sekwencje.',
    tags: ['Glitch', 'Rhythm']
  },
  {
    icon: 'V',
    title: 'Resynteza głosu i field recording',
    text: 'Przetwarzanie źródeł mowy i nagrań terenowych do form eksperymentalnych.',
    tags: ['Voice', 'Field Recording']
  },
  {
    icon: 'B',
    title: 'Praca badawczo-artystyczna',
    text: 'Eksploracja interaktywnych systemów audio i multimodalności w praktyce twórczej.',
    tags: ['Research', 'Interactive']
  }
];

const guiItems = [
  {
    id: 'controls',
    chip: 'Controls',
    title: 'Controls Panel',
    shortDescription: 'Główna warstwa kreacji i parametry granulacji.',
    imageSrc: withBase('/assets/plugin/controls-panel.png'),
    imageAlt: 'Panel Controls we wtyczce GreggularVST',
    description:
      'Główna warstwa kreacji: Duration, Pitch, Gain, Envelope i Cloud. To tutaj ustawiane są parametry odpowiadające za charakter i dynamikę chmury granularnej.',
    bullets: ['Sterowanie zakresem i dynamiką', 'Szybki dostęp do kluczowych parametrów', 'Tryb pracy nastawiony na iteracje'],
    tags: ['Duration', 'Pitch', 'Cloud']
  },
  {
    id: 'multichannel',
    chip: 'Multichannel',
    title: 'Multichannel Panel',
    shortDescription: 'Routing kanałów i panorama dla złożonych układów.',
    imageSrc: withBase('/assets/plugin/multichannel-panel.png'),
    imageAlt: 'Panel Multichannel we wtyczce GreggularVST',
    description:
      'Routing kanałów z kontrolą aktywności, mute/solo i konfiguracją par panorama. Panel umożliwia pracę od stereo po rozszerzone układy wielokanałowe.',
    bullets: ['Kontrola kanałów wyjściowych', 'Parowanie L/R i panorama', 'Skalowalność dla układów surround'],
    tags: ['Routing', 'Mute/Solo', 'Surround']
  },
  {
    id: 'audio-generator',
    chip: 'Audio Generator',
    title: 'Audio Generator (AI)',
    shortDescription: 'Generowanie materiału audio i iteracje promptowe.',
    imageSrc: withBase('/assets/plugin/audio-generator-panel.png'),
    imageAlt: 'Panel Audio Generator (AI) we wtyczce GreggularVST',
    description:
      'Interfejs konwersacyjny do generowania materiału audio i zarządzania sesją. Rozszerza workflow o komponent promptowy i szybkie iteracje wariantów brzmieniowych.',
    bullets: ['Tworzenie wariantów materiału audio', 'Obsługa kontekstu sesji', 'Workflow promptowy dla sound designu'],
    tags: ['Generator', 'Prompt', 'Session']
  }
];

const initialPanel = guiItems[0];
---

<PageLayout
  lang="pl"
  title="Wtyczka VST | Projekt stypendialny"
  description="Opis wtyczki GreggularVST: funkcjonalności, panele i zastosowania."
>
  <section id="panels" class="content-stack">
    <p class="section-kicker">Wtyczka VST</p>
    <article class="plugin-intro-panel">
      <div class="plugin-intro-panel__title">
        <h2>GreggularVST</h2>
      </div>
      <div class="plugin-intro-panel__body">
        <p>
          GreggularVST to autorska wtyczka JUCE (VST3) do generatywnego przetwarzania krótkich nagrań
          i budowania wielowarstwowych struktur granularnych. Narzędzie wspiera pracę kompozytorską, sound design
          i eksperymentalne podejście do kreacji dźwięku.
        </p>
      </div>
    </article>
  </section>

  <section class="content-stack">
    <p class="section-kicker">Panele interfejsu</p>
    <h2>Panele</h2>
    <div class="plugin-panels" data-plugin-panels data-initial-id={initialPanel.id}>
      <div class="plugin-panels-nav">
      {guiItems.map((item) => (
        <button type="button" class={`plugin-panel-tile ${item.id === initialPanel.id ? 'is-active' : ''}`} data-panel-id={item.id} aria-pressed={item.id === initialPanel.id ? 'true' : 'false'}>
          <img src={item.imageSrc} alt={item.imageAlt} loading="lazy" />
          <div class="plugin-panel-tile__body">
            <h3>{item.title}</h3>
            <p>{item.shortDescription}</p>
            <div class="plugin-tag-row">
              {item.tags.map((tag) => (
                <span class="plugin-tag">{tag}</span>
              ))}
            </div>
          </div>
        </button>
      ))}
      </div>

      <article class="plugin-panel-active" data-panel-active aria-live="polite">
        <div class="plugin-panel-active__media">
          <img src={initialPanel.imageSrc} alt={initialPanel.imageAlt} loading="lazy" data-active-image />
          <p class="plugin-panel-active__caption" data-active-caption>{initialPanel.shortDescription}</p>
        </div>
        <div class="plugin-panel-active__content">
          <p class="plugin-panel-active__kicker">Aktywny panel</p>
          <h3 data-active-title>{initialPanel.title}</h3>
          <p class="plugin-panel-active__description" data-active-description>{initialPanel.description}</p>
          <section class="plugin-panel-active__highlights">
            <h4>Szczegóły panelu</h4>
            <ul data-active-bullets>
              {initialPanel.bullets.map((bullet) => (
                <li>{bullet}</li>
              ))}
            </ul>
          </section>
          <div class="plugin-panel-active__switch" aria-label="Nawigacja paneli">
            <button type="button" class="plugin-panel-active__arrow" data-panel-prev aria-label="Poprzedni panel">←</button>
            <button type="button" class="plugin-panel-active__arrow" data-panel-next aria-label="Następny panel">→</button>
          </div>
        </div>
      </article>
    </div>

    <div class="text-panel">
      <p>
        Kontekst naukowy i materiały konferencyjne są dostępne w zakładce <a href={withBase('/pl/research/')}>Badania</a>.
      </p>
    </div>
  </section>

  <section class="content-stack">
    <p class="section-kicker">Funkcjonalności</p>
    <h2>Co potrafi wtyczka</h2>
    <div class="plugin-feature-grid">
      {capabilityCards.map((item) => (
        <article class="plugin-feature-card">
          <div class="plugin-feature-card__head">
            <span class="plugin-feature-card__icon">{item.icon}</span>
            <h3>{item.title}</h3>
          </div>
          <p>{item.text}</p>
          <div class="plugin-tag-row">
            {item.tags.map((tag) => (
              <span class="plugin-tag">{tag}</span>
            ))}
          </div>
        </article>
      ))}
    </div>
  </section>

  <section class="content-stack">
    <p class="section-kicker">Use case</p>
    <h2>Zastosowania twórcze</h2>
    <div class="plugin-feature-grid plugin-feature-grid--compact">
      {useCaseCards.map((item) => (
        <article class="plugin-feature-card">
          <div class="plugin-feature-card__head">
            <span class="plugin-feature-card__icon">{item.icon}</span>
            <h3>{item.title}</h3>
          </div>
          <p>{item.text}</p>
          <div class="plugin-tag-row">
            {item.tags.map((tag) => (
              <span class="plugin-tag">{tag}</span>
            ))}
          </div>
        </article>
      ))}
    </div>
  </section>

  <section class="content-stack">
    <p class="section-kicker">Pobieranie</p>
    <h2>Pobieranie</h2>
    <ReleaseCard
      name="Generatywny syntezator granularny VST"
      version="v0.1.0-alpha"
      date="2026-02-21"
    >
      <Fragment slot="action">
        <DownloadGateModal
          lang="pl"
          pluginVersion="v0.1.0-alpha"
          contactEmailLocal="grzegorzsamson218"
          contactEmailDomain="hotmail"
          contactEmailTld="com"
        />
      </Fragment>
    </ReleaseCard>
  </section>
</PageLayout>

<script define:vars={{ guiItems }}>
  const roots = document.querySelectorAll('[data-plugin-panels]');

  for (const root of roots) {
    const buttons = Array.from(root.querySelectorAll('button[data-panel-id]'));
    const activeCard = root.querySelector('[data-panel-active]');
    const image = root.querySelector('[data-active-image]');
    const caption = root.querySelector('[data-active-caption]');
    const title = root.querySelector('[data-active-title]');
    const description = root.querySelector('[data-active-description]');
    const bullets = root.querySelector('[data-active-bullets]');
    const prevButton = root.querySelector('[data-panel-prev]');
    const nextButton = root.querySelector('[data-panel-next]');

    if (!buttons.length || !activeCard || !image || !caption || !title || !description || !bullets) continue;

    const itemMap = new Map(guiItems.map((item) => [item.id, item]));
    const ids = buttons
      .map((button) => button.dataset.panelId)
      .filter((value) => typeof value === 'string' && value.length > 0);
    let activeId = ids[0] ?? '';

    const setActive = (id, scrollToCard = true) => {
      const item = itemMap.get(id);
      if (!item) return;
      activeId = id;

      for (const button of buttons) {
        const isActive = button.dataset.panelId === id;
        button.classList.toggle('is-active', isActive);
        button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      }

      image.setAttribute('src', item.imageSrc);
      image.setAttribute('alt', item.imageAlt);
      caption.textContent = item.shortDescription ?? item.description;
      title.textContent = item.title;
      description.textContent = item.description;

      bullets.textContent = '';
      for (const entry of item.bullets ?? []) {
        const li = document.createElement('li');
        li.textContent = entry;
        bullets.appendChild(li);
      }

      const activeIndex = ids.indexOf(id);
      if (prevButton instanceof HTMLButtonElement) {
        prevButton.disabled = activeIndex <= 0;
      }
      if (nextButton instanceof HTMLButtonElement) {
        nextButton.disabled = activeIndex === -1 || activeIndex >= ids.length - 1;
      }

      if (scrollToCard) {
        activeCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    };

    for (const button of buttons) {
      button.addEventListener('click', () => {
        const id = button.dataset.panelId;
        if (id) setActive(id, true);
      });
    }

    prevButton?.addEventListener('click', () => {
      const index = ids.indexOf(activeId);
      if (index > 0) {
        setActive(ids[index - 1], true);
      }
    });

    nextButton?.addEventListener('click', () => {
      const index = ids.indexOf(activeId);
      if (index >= 0 && index < ids.length - 1) {
        setActive(ids[index + 1], true);
      }
    });

    const initialId = root.getAttribute('data-initial-id');
    if (initialId) setActive(initialId, false);
  }
</script>
