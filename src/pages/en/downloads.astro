---
import PageLayout from '../../layouts/PageLayout.astro';
import ReleaseCard from '../../components/ReleaseCard.astro';
import DownloadGateModal from '../../components/DownloadGateModal.astro';
import { withBase } from '../../lib/paths';

const capabilityCards = [
  {
    icon: 'G',
    title: 'Multi-source granular engine',
    text: 'Load multiple WAV files into a shared buffer and build complex grain clouds in real time.',
    tags: ['Granular', 'WAV', 'Live']
  },
  {
    icon: 'P',
    title: 'Precise parameter control',
    text: 'Control grain duration, cloud density, pitch and loudness spread, and envelope behavior.',
    tags: ['Pitch', 'Gain', 'Envelope']
  },
  {
    icon: 'W',
    title: 'Waveform-driven workflow',
    text: 'Select, group, and edit sampling ranges directly on waveform previews.',
    tags: ['Waveform', 'Selection', 'Editing']
  },
  {
    icon: 'M',
    title: 'Extended channel routing',
    text: 'Multichannel panel with routing, mute/solo, and pan pairs for complex output layouts.',
    tags: ['Routing', 'Multichannel', 'Pan']
  },
  {
    icon: 'A',
    title: 'Audio Generator (AI)',
    text: 'Conversation-based panel supporting audio material generation and rapid sonic iterations.',
    tags: ['Generator', 'Prompt', 'Session']
  }
];

const useCaseCards = [
  {
    icon: 'F',
    title: 'Film textures and drones',
    text: 'Build atmospheres and background layers with continuous, evolving structure.',
    tags: ['Cinematic', 'Ambient']
  },
  {
    icon: 'R',
    title: 'Rhythmic glitches',
    text: 'Deconstruct and reassemble percussive material into irregular sequences.',
    tags: ['Glitch', 'Rhythm']
  },
  {
    icon: 'V',
    title: 'Voice and field recording resynthesis',
    text: 'Transform speech and field sources into experimental forms.',
    tags: ['Voice', 'Field Recording']
  },
  {
    icon: 'B',
    title: 'Artistic-research practice',
    text: 'Explore interactive audio systems and multimodality in creative work.',
    tags: ['Research', 'Interactive']
  }
];

const guiItems = [
  {
    id: 'controls',
    chip: 'Controls',
    title: 'Controls Panel',
    shortDescription: 'Core creation layer and key granular parameters.',
    imageSrc: withBase('/assets/plugin/controls-panel.png'),
    imageAlt: 'Controls panel in GreggularVST plugin',
    description:
      'Core creation layer: Duration, Pitch, Gain, Envelope, and Cloud. This is where parameters that shape the character and dynamics of the granular cloud are configured.',
    bullets: ['Range and dynamics control', 'Fast access to key parameters', 'Iteration-focused working mode'],
    tags: ['Duration', 'Pitch', 'Cloud']
  },
  {
    id: 'multichannel',
    chip: 'Multichannel',
    title: 'Multichannel Panel',
    shortDescription: 'Channel routing and panning for complex output layouts.',
    imageSrc: withBase('/assets/plugin/multichannel-panel.png'),
    imageAlt: 'Multichannel panel in GreggularVST plugin',
    description:
      'Channel routing with activity control, mute/solo, and pan pair configuration. The panel supports workflows from stereo to extended multichannel setups.',
    bullets: ['Output channel control', 'L/R pairing and panning', 'Scalable for surround layouts'],
    tags: ['Routing', 'Mute/Solo', 'Surround']
  },
  {
    id: 'audio-generator',
    chip: 'Audio Generator',
    title: 'Audio Generator (AI)',
    shortDescription: 'Audio material generation with prompt-driven iteration.',
    imageSrc: withBase('/assets/plugin/audio-generator-panel.png'),
    imageAlt: 'Audio Generator (AI) panel in GreggularVST plugin',
    description:
      'Conversation interface for generating audio material and managing session context. It extends the workflow with prompt-driven ideation and rapid sonic variation.',
    bullets: ['Create variants of audio material', 'Session context handling', 'Prompt workflow for sound design'],
    tags: ['Generator', 'Prompt', 'Session']
  }
];

const initialPanel = guiItems[0];
---

<PageLayout
  lang="en"
  title="VST Plugin | Scholarship project"
  description="GreggularVST overview: features, panels, and use cases."
>
  <section id="panels" class="content-stack">
    <p class="section-kicker">VST Plugin</p>
    <article class="plugin-intro-panel">
      <div class="plugin-intro-panel__title">
        <h2>GreggularVST</h2>
      </div>
      <div class="plugin-intro-panel__body">
        <p>
          GreggularVST is a custom JUCE plugin (VST3) for generative processing of short recordings and
          building multilayer granular structures. The tool supports composition work, sound design,
          and experimental approaches to sound creation.
        </p>
      </div>
    </article>
  </section>

  <section class="content-stack">
    <p class="section-kicker">Interface panels</p>
    <h2>Panels</h2>
    <div class="plugin-panels" data-plugin-panels data-initial-id={initialPanel.id}>
      <div class="plugin-panels-nav">
      {guiItems.map((item) => (
        <button type="button" class={`plugin-panel-tile ${item.id === initialPanel.id ? 'is-active' : ''}`} data-panel-id={item.id} aria-pressed={item.id === initialPanel.id ? 'true' : 'false'}>
          <img src={item.imageSrc} alt={item.imageAlt} loading="lazy" />
          <div class="plugin-panel-tile__body">
            <h3>{item.title}</h3>
            <p>{item.shortDescription}</p>
            <div class="plugin-tag-row">
              {item.tags.map((tag) => (
                <span class="plugin-tag">{tag}</span>
              ))}
            </div>
          </div>
        </button>
      ))}
      </div>

      <article class="plugin-panel-active" data-panel-active aria-live="polite">
        <div class="plugin-panel-active__media">
          <img src={initialPanel.imageSrc} alt={initialPanel.imageAlt} loading="lazy" data-active-image />
          <p class="plugin-panel-active__caption" data-active-caption>{initialPanel.shortDescription}</p>
        </div>
        <div class="plugin-panel-active__content">
          <p class="plugin-panel-active__kicker">Active panel</p>
          <h3 data-active-title>{initialPanel.title}</h3>
          <p class="plugin-panel-active__description" data-active-description>{initialPanel.description}</p>
          <section class="plugin-panel-active__highlights">
            <h4>Panel details</h4>
            <ul data-active-bullets>
              {initialPanel.bullets.map((bullet) => (
                <li>{bullet}</li>
              ))}
            </ul>
          </section>
          <div class="plugin-panel-active__switch" aria-label="Panel navigation">
            <button type="button" class="plugin-panel-active__arrow" data-panel-prev aria-label="Previous panel">←</button>
            <button type="button" class="plugin-panel-active__arrow" data-panel-next aria-label="Next panel">→</button>
          </div>
        </div>
      </article>
    </div>

    <div class="text-panel">
      <p>
        Research context and conference materials are available in the <a href={withBase('/en/research/')}>Research</a> tab.
      </p>
    </div>
  </section>

  <section class="content-stack">
    <p class="section-kicker">Capabilities</p>
    <h2>What the plugin can do</h2>
    <div class="plugin-feature-grid">
      {capabilityCards.map((item) => (
        <article class="plugin-feature-card">
          <div class="plugin-feature-card__head">
            <span class="plugin-feature-card__icon">{item.icon}</span>
            <h3>{item.title}</h3>
          </div>
          <p>{item.text}</p>
          <div class="plugin-tag-row">
            {item.tags.map((tag) => (
              <span class="plugin-tag">{tag}</span>
            ))}
          </div>
        </article>
      ))}
    </div>
  </section>

  <section class="content-stack">
    <p class="section-kicker">Use case</p>
    <h2>Creative applications</h2>
    <div class="plugin-feature-grid plugin-feature-grid--compact">
      {useCaseCards.map((item) => (
        <article class="plugin-feature-card">
          <div class="plugin-feature-card__head">
            <span class="plugin-feature-card__icon">{item.icon}</span>
            <h3>{item.title}</h3>
          </div>
          <p>{item.text}</p>
          <div class="plugin-tag-row">
            {item.tags.map((tag) => (
              <span class="plugin-tag">{tag}</span>
            ))}
          </div>
        </article>
      ))}
    </div>
  </section>

  <section class="content-stack">
    <p class="section-kicker">Download</p>
    <h2>Download</h2>
    <ReleaseCard
      name="Generative granular synthesizer VST"
      version="v0.1.0-alpha"
      date="2026-02-21"
    >
      <Fragment slot="action">
        <DownloadGateModal
          lang="en"
          pluginVersion="v0.1.0-alpha"
          contactEmailLocal="grzegorzsamson218"
          contactEmailDomain="hotmail"
          contactEmailTld="com"
        />
      </Fragment>
    </ReleaseCard>
  </section>
</PageLayout>

<script define:vars={{ guiItems }}>
  const roots = document.querySelectorAll('[data-plugin-panels]');

  for (const root of roots) {
    const buttons = Array.from(root.querySelectorAll('button[data-panel-id]'));
    const activeCard = root.querySelector('[data-panel-active]');
    const image = root.querySelector('[data-active-image]');
    const caption = root.querySelector('[data-active-caption]');
    const title = root.querySelector('[data-active-title]');
    const description = root.querySelector('[data-active-description]');
    const bullets = root.querySelector('[data-active-bullets]');
    const prevButton = root.querySelector('[data-panel-prev]');
    const nextButton = root.querySelector('[data-panel-next]');

    if (!buttons.length || !activeCard || !image || !caption || !title || !description || !bullets) continue;

    const itemMap = new Map(guiItems.map((item) => [item.id, item]));
    const ids = buttons
      .map((button) => button.dataset.panelId)
      .filter((value) => typeof value === 'string' && value.length > 0);
    let activeId = ids[0] ?? '';

    const setActive = (id, scrollToCard = true) => {
      const item = itemMap.get(id);
      if (!item) return;
      activeId = id;

      for (const button of buttons) {
        const isActive = button.dataset.panelId === id;
        button.classList.toggle('is-active', isActive);
        button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      }

      image.setAttribute('src', item.imageSrc);
      image.setAttribute('alt', item.imageAlt);
      caption.textContent = item.shortDescription ?? item.description;
      title.textContent = item.title;
      description.textContent = item.description;

      bullets.textContent = '';
      for (const entry of item.bullets ?? []) {
        const li = document.createElement('li');
        li.textContent = entry;
        bullets.appendChild(li);
      }

      const activeIndex = ids.indexOf(id);
      if (prevButton instanceof HTMLButtonElement) {
        prevButton.disabled = activeIndex <= 0;
      }
      if (nextButton instanceof HTMLButtonElement) {
        nextButton.disabled = activeIndex === -1 || activeIndex >= ids.length - 1;
      }

      if (scrollToCard) {
        activeCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    };

    for (const button of buttons) {
      button.addEventListener('click', () => {
        const id = button.dataset.panelId;
        if (id) setActive(id, true);
      });
    }

    prevButton?.addEventListener('click', () => {
      const index = ids.indexOf(activeId);
      if (index > 0) {
        setActive(ids[index - 1], true);
      }
    });

    nextButton?.addEventListener('click', () => {
      const index = ids.indexOf(activeId);
      if (index >= 0 && index < ids.length - 1) {
        setActive(ids[index + 1], true);
      }
    });

    const initialId = root.getAttribute('data-initial-id');
    if (initialId) setActive(initialId, false);
  }
</script>
