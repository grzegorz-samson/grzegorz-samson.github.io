---
type PluginGuiItem = {
  id: string;
  chip: string;
  title: string;
  imageSrc: string;
  imageAlt: string;
  description: string;
  bullets?: string[];
};

const { items = [], initialId }: { items: PluginGuiItem[]; initialId?: string } = Astro.props;
const startId = items.some((item) => item.id === initialId) ? initialId : items[0]?.id;
---

<div class="plugin-gui-slider" data-plugin-gui-slider data-initial-id={startId}>
  <div class="plugin-gui-slider__chips" role="tablist" aria-label="Panele GUI">
    {items.map((item) => (
      <button
        type="button"
        role="tab"
        class={`plugin-gui-slider__chip ${item.id === startId ? 'is-active' : ''}`}
        data-chip-id={item.id}
        aria-selected={item.id === startId ? 'true' : 'false'}
      >
        {item.chip}
      </button>
    ))}
  </div>

  <div class="plugin-gui-slider__viewport" data-slider-viewport>
    <div class="plugin-gui-slider__track">
      {items.map((item) => (
        <article
          role="tabpanel"
          class={`plugin-gui-slider__slide ${item.id === startId ? 'is-active' : ''}`}
          data-slide-id={item.id}
          aria-live={item.id === startId ? 'polite' : undefined}
        >
          <img src={item.imageSrc} alt={item.imageAlt} loading="lazy" />
          <div class="plugin-gui-slider__content">
            <h3>{item.title}</h3>
            <p>{item.description}</p>
            {item.bullets && item.bullets.length > 0 && (
              <ul>
                {item.bullets.map((bullet) => (
                  <li>{bullet}</li>
                ))}
              </ul>
            )}
          </div>
        </article>
      ))}
    </div>
  </div>
</div>

<script>
  const roots = document.querySelectorAll('[data-plugin-gui-slider]');

  for (const root of roots) {
    const chips = Array.from(root.querySelectorAll('button[data-chip-id]'));
    const slides = Array.from(root.querySelectorAll('[data-slide-id]'));
    const viewport = root.querySelector('[data-slider-viewport]');
    const initialId = root.getAttribute('data-initial-id');

    if (!chips.length || !slides.length || !viewport) continue;

    const slideMap = new Map(slides.map((slide) => [slide.getAttribute('data-slide-id'), slide]));

    const setActive = (id, shouldScroll = true) => {
      if (!slideMap.has(id)) return;

      for (const chip of chips) {
        const isActive = chip.getAttribute('data-chip-id') === id;
        chip.classList.toggle('is-active', isActive);
        chip.setAttribute('aria-selected', isActive ? 'true' : 'false');
      }

      for (const slide of slides) {
        const isActive = slide.getAttribute('data-slide-id') === id;
        slide.classList.toggle('is-active', isActive);
        if (isActive) {
          slide.setAttribute('aria-live', 'polite');
        } else {
          slide.removeAttribute('aria-live');
        }
      }

      if (shouldScroll) {
        const target = slideMap.get(id);
        target?.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
      }
    };

    const orderedIds = chips
      .map((chip) => chip.getAttribute('data-chip-id'))
      .filter((value) => typeof value === 'string');

    for (const chip of chips) {
      chip.addEventListener('click', () => {
        const id = chip.getAttribute('data-chip-id');
        if (id) setActive(id, true);
      });

      chip.addEventListener('keydown', (event) => {
        const currentId = chip.getAttribute('data-chip-id');
        if (!currentId) return;
        const currentIndex = orderedIds.indexOf(currentId);
        if (currentIndex < 0) return;

        if (event.key === 'ArrowRight') {
          event.preventDefault();
          const nextId = orderedIds[(currentIndex + 1) % orderedIds.length];
          if (!nextId) return;
          const nextChip = chips.find((entry) => entry.getAttribute('data-chip-id') === nextId);
          nextChip?.focus();
          setActive(nextId, true);
        }

        if (event.key === 'ArrowLeft') {
          event.preventDefault();
          const prevId = orderedIds[(currentIndex - 1 + orderedIds.length) % orderedIds.length];
          if (!prevId) return;
          const prevChip = chips.find((entry) => entry.getAttribute('data-chip-id') === prevId);
          prevChip?.focus();
          setActive(prevId, true);
        }
      });
    }

    let rafToken = 0;
    const syncFromScroll = () => {
      if (rafToken) return;
      rafToken = requestAnimationFrame(() => {
        rafToken = 0;
        const viewportRect = viewport.getBoundingClientRect();
        const viewportCenter = viewportRect.left + viewportRect.width / 2;
        let closestId = '';
        let closestDistance = Number.POSITIVE_INFINITY;

        for (const slide of slides) {
          const rect = slide.getBoundingClientRect();
          const center = rect.left + rect.width / 2;
          const distance = Math.abs(center - viewportCenter);
          if (distance < closestDistance) {
            closestDistance = distance;
            closestId = slide.getAttribute('data-slide-id') ?? '';
          }
        }

        if (closestId) setActive(closestId, false);
      });
    };

    viewport.addEventListener('scroll', syncFromScroll, { passive: true });

    if (initialId) {
      setActive(initialId, false);
      const initialSlide = slideMap.get(initialId);
      initialSlide?.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'start' });
    }
  }
</script>
