---
type TimelineItem = {
  id: string;
  year: string;
  date: string;
  label: string;
  title: string;
  description: string;
};

const { items = [], initialId }: { items: TimelineItem[]; initialId?: string } = Astro.props;

const startId = items.some((item) => item.id === initialId) ? initialId : items[0]?.id;
const startItem = items.find((item) => item.id === startId) ?? items[0];
---

<div class="horizontal-timeline" data-horizontal-timeline data-initial-id={startId}>
  <div class="horizontal-timeline__viewport">
    <div class="horizontal-timeline__rail" role="tablist" aria-label="Oś czasu aktywności">
      {items.map((item, index) => {
        const isYearStart = index === 0 || items[index - 1].year !== item.year;
        return (
          <div class={`horizontal-timeline__node ${isYearStart ? 'is-year-start' : ''}`}>
            {isYearStart && (
              <div class="horizontal-timeline__year-divider" aria-hidden="true">
                <span class="horizontal-timeline__year-line"></span>
                <span class="horizontal-timeline__year-label">{item.year}</span>
              </div>
            )}
            <button
              type="button"
              class={`horizontal-timeline__dot ${item.id === startId ? 'is-active' : ''}`}
              data-timeline-id={item.id}
              aria-pressed={item.id === startId ? 'true' : 'false'}
              aria-label={`${item.year} — ${item.title}`}
            >
              <span class="horizontal-timeline__short">{item.label}</span>
            </button>
          </div>
        );
      })}
    </div>
  </div>

  <article class="horizontal-timeline__panel" aria-live="polite">
    <p class="horizontal-timeline__panel-date" data-timeline-date>{startItem?.date}</p>
    <h3 data-timeline-title>{startItem?.title}</h3>
    <p data-timeline-description>{startItem?.description}</p>
  </article>
</div>

<script define:vars={{ items }}>
  const roots = document.querySelectorAll('[data-horizontal-timeline]');

  for (const root of roots) {
    const buttons = Array.from(root.querySelectorAll('button[data-timeline-id]'));
    const dateEl = root.querySelector('[data-timeline-date]');
    const titleEl = root.querySelector('[data-timeline-title]');
    const descEl = root.querySelector('[data-timeline-description]');

    if (!buttons.length || !dateEl || !titleEl || !descEl) continue;

    const map = new Map(items.map((item) => [item.id, item]));

    const setActive = (id) => {
      const active = map.get(id);
      if (!active) return;

      for (const button of buttons) {
        const isActive = button.dataset.timelineId === id;
        button.classList.toggle('is-active', isActive);
        button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      }

      dateEl.textContent = active.date;
      titleEl.textContent = active.title;
      descEl.textContent = active.description;
    };

    for (const button of buttons) {
      button.addEventListener('click', () => {
        const id = button.dataset.timelineId;
        if (id) setActive(id);
      });

      button.addEventListener('mouseenter', () => {
        const id = button.dataset.timelineId;
        if (id) setActive(id);
      });

      button.addEventListener('focus', () => {
        const id = button.dataset.timelineId;
        if (id) setActive(id);
      });
    }

    const initialFromAttr = root.getAttribute('data-initial-id');
    if (initialFromAttr) setActive(initialFromAttr);
  }
</script>
