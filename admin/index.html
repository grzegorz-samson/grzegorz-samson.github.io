<!DOCTYPE html><html lang="pl"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Astro v5.17.3"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="icon" href="/favicon.ico"><title>Admin Analytics | GreggularVST</title><meta name="description" content="Prywatny panel statystyk i wizualizacji z backendu download-gate-api."><meta property="og:title" content="Admin Analytics | GreggularVST"><meta property="og:type" content="website"><meta property="og:url" content="https://username.github.io/admin/"><meta property="og:description" content="Prywatny panel statystyk i wizualizacji z backendu download-gate-api."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Admin Analytics | GreggularVST"><meta name="twitter:description" content="Prywatny panel statystyk i wizualizacji z backendu download-gate-api."><link rel="stylesheet" href="/_astro/admin.TCZwfvx_.css"></head> <body> <div class="site-bg"></div> <header class="main-header"> <a class="brand" href="/pl/">GS</a> <nav> <a href="/pl/project/"> Projekt </a><a href="/pl/plugin/"> Wtyczka VST </a><a href="/pl/research/"> Badania </a><a href="/pl/workshops/"> Warsztaty </a><a href="/pl/scholarship/"> Stypendium </a><a href="/pl/bio/"> Bio </a> </nav> <div class="lang-switch"> <a class="active" href="/pl/admin/">PL</a> <a class href="/en/admin/">EN</a> </div> </header> <main class="container">  <section class="content-stack"> <p class="section-kicker">Admin</p> <h1>Panel statystyk i wizualizacji</h1> <div class="text-panel admin-console"> <p>
Lokalny panel do odczytu endpointów admin. Token nie jest zapisywany w repo ani w pamięci przeglądarki i jest
        wpisywany ręcznie przy każdym użyciu.
</p> <div class="admin-form-grid"> <label> <span>API base</span> <input type="text" data-admin-api value="https://download-gate-api.s20796-download-gate.workers.dev" placeholder="https://twoj-worker.workers.dev"> </label> <label> <span>Admin token</span> <input type="password" data-admin-token placeholder="ADMIN_API_TOKEN" autocomplete="off"> </label> <label> <span>Zakres dni</span> <input type="number" data-admin-days min="1" max="365" value="30"> </label> <label> <span>Limit rekordów</span> <input type="number" data-admin-limit min="1" max="200" value="30"> </label> </div> <div class="admin-actions"> <button type="button" class="button button-primary" data-admin-load-stats>Pobierz statystyki</button> <button type="button" class="button button-ghost" data-admin-load-events>Odśwież eventy lejka</button> <button type="button" class="button button-ghost" data-admin-load-pageviews>Pageviews (JSON)</button> <button type="button" class="button button-ghost" data-admin-load-downloads>Pobrania (tabela)</button> <button type="button" class="button button-ghost" data-admin-load-contacts>Kontakt (JSON)</button> </div> <p class="admin-status" data-admin-status hidden></p> <div class="admin-summary-grid" data-admin-summary hidden> <article class="admin-summary-card"> <h3>Pageviews</h3> <p data-summary-pageviews>0</p> </article> <article class="admin-summary-card"> <h3>Eventy lejka</h3> <p data-summary-events>0</p> </article> <article class="admin-summary-card"> <h3>Pobrania</h3> <p data-summary-downloads>0</p> </article> <article class="admin-summary-card"> <h3>Kontakt</h3> <p data-summary-contacts>0</p> </article> <article class="admin-summary-card"> <h3>Unikalni użytkownicy</h3> <p data-summary-visitors>0</p> </article> </div> <div class="admin-viz-grid" data-admin-viz hidden> <article class="admin-viz-card"> <h3>Dzienne pageviews</h3> <ul class="admin-bar-list" data-chart-pageviews></ul> </article> <article class="admin-viz-card"> <h3>Dzienne eventy</h3> <ul class="admin-bar-list" data-chart-events></ul> </article> <article class="admin-viz-card"> <h3>Dzienne pobrania</h3> <ul class="admin-bar-list" data-chart-downloads></ul> </article> <article class="admin-viz-card"> <h3>Dzienne kontakty</h3> <ul class="admin-bar-list" data-chart-contacts></ul> </article> <article class="admin-viz-card"> <h3>Top ścieżki</h3> <ul class="admin-top-list" data-top-paths></ul> </article> <article class="admin-viz-card"> <h3>Top eventy lejka</h3> <ul class="admin-top-list" data-top-events></ul> </article> </div> <article class="admin-viz-card" data-recent-events-wrap hidden> <h3>Ostatnie eventy lejka</h3> <p class="admin-table-empty" data-recent-events-empty hidden>Brak danych eventów.</p> <div class="admin-table-wrap"> <table class="admin-table"> <thead> <tr> <th>Czas</th> <th>Event</th> <th>Status</th> <th>Path</th> </tr> </thead> <tbody data-recent-events></tbody> </table> </div> </article> <article class="admin-viz-card" data-downloads-table-wrap hidden> <h3>Ostatnie pobrania</h3> <p class="admin-table-empty" data-downloads-table-empty hidden>Brak danych pobran.</p> <div class="admin-table-wrap"> <table class="admin-table"> <thead> <tr> <th>Czas</th> <th>Imie i nazwisko</th> <th>E-mail</th> <th>Role</th> <th>Powiazanie</th> <th>Zgody</th> </tr> </thead> <tbody data-downloads-table-body></tbody> </table> </div> </article> <details class="admin-json-panel"> <summary>Pokaż surowy JSON</summary> <div class="admin-output-grid"> <article class="admin-output-card"> <h3>Statystyki (JSON)</h3> <pre data-admin-stats>// Brak danych</pre> </article> <article class="admin-output-card"> <h3>Eventy (JSON)</h3> <pre data-admin-events>// Brak danych</pre> </article> <article class="admin-output-card"> <h3>Pageviews (JSON)</h3> <pre data-admin-pageviews>// Brak danych</pre> </article> <article class="admin-output-card"> <h3>Pobrania (JSON)</h3> <pre data-admin-downloads>// Brak danych</pre> </article> <article class="admin-output-card"> <h3>Kontakt (JSON)</h3> <pre data-admin-contacts>// Brak danych</pre> </article> </div> </details> </div> </section>  </main> <footer class="main-footer"> <p>Nowe technologie w rozwoju narzędzi i kompetencji technologicznych dla współczesnej muzyki</p> <p>09.2025 - 02.2026</p> </footer> <section class="funding-footer" aria-label="Informacja o finansowaniu projektu"> <div class="funding-logos"> <img src="/assets/funding/kpo-ngeu-achromatic.png" alt="KPO i NextGenerationEU - wariant achromatyczny" class="funding-logo-white" loading="lazy"> </div> <p class="funding-note">Działania poprowadzone w ramach projektu stypendialnego „Nowe technologie w rozwoju narzędzi i kompetencji technologicznych dla współczesnej muzyki” realizowanego przez Grzegorza Samsona. Sfinansowane przez Unię Europejską NextGenerationEU.</p> </section> <script>(function(){const apiBase = "https://download-gate-api.s20796-download-gate.workers.dev";
const lang = "pl";

    (() => {
      try {
        const endpoint = `${String(apiBase).replace(/\/$/, '')}/analytics/pageview`;
        const payload = {
          path: window.location.pathname,
          lang: lang || document.documentElement.lang || '',
          referrer: document.referrer || '',
          website: ''
        };
        const body = JSON.stringify(payload);

        if (navigator.sendBeacon) {
          const blob = new Blob([body], { type: 'application/json' });
          navigator.sendBeacon(endpoint, blob);
          return;
        }

        fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body,
          keepalive: true
        }).catch(() => {});
      } catch {
        // noop
      }
    })();
  })();</script> <script type="module">const T=["main.container",".funding-footer"],a=new Set(["A","BUTTON","CODE","INPUT","KBD","LABEL","OPTION","PRE","SCRIPT","SELECT","STYLE","TEXTAREA"]),l=["a","i","o","u","w","z","na","do","od","po","za","we","ze"],E=new RegExp(`(^|[\\s([{"'“”„«»])(${l.join("|")})\\s+`,"giu"),u=e=>{let t=e.parentElement;for(;t;){if(a.has(t.tagName))return!0;t=t.parentElement}return!1},d=e=>e.replace(E,(t,n,o)=>`${n}${o} `),N={acceptNode(e){return!(e instanceof Text)||!e.textContent||!e.textContent.trim()||u(e)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}},p=()=>{if(document.documentElement.lang==="pl")for(const e of T){const t=document.querySelector(e);if(!(t instanceof HTMLElement))continue;const n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,N),o=[];let r=n.nextNode();for(;r;)o.push(r),r=n.nextNode();for(const c of o){const i=c.textContent??"",s=d(i);s!==i&&(c.textContent=s)}}},f=()=>{p()};f();</script> </body> </html> <script type="module">
  const STORAGE_API = 'adminApiBase';

  const apiInput = document.querySelector('[data-admin-api]');
  const tokenInput = document.querySelector('[data-admin-token]');
  const daysInput = document.querySelector('[data-admin-days]');
  const limitInput = document.querySelector('[data-admin-limit]');
  const statusBox = document.querySelector('[data-admin-status]');
  const summaryWrap = document.querySelector('[data-admin-summary]');
  const vizWrap = document.querySelector('[data-admin-viz]');
  const recentEventsWrap = document.querySelector('[data-recent-events-wrap]');
  const recentEventsEmpty = document.querySelector('[data-recent-events-empty]');
  const recentEventsBody = document.querySelector('[data-recent-events]');
  const downloadsTableWrap = document.querySelector('[data-downloads-table-wrap]');
  const downloadsTableEmpty = document.querySelector('[data-downloads-table-empty]');
  const downloadsTableBody = document.querySelector('[data-downloads-table-body]');

  const chartNodes = {
    pageviews: document.querySelector('[data-chart-pageviews]'),
    events: document.querySelector('[data-chart-events]'),
    downloads: document.querySelector('[data-chart-downloads]'),
    contacts: document.querySelector('[data-chart-contacts]'),
    topPaths: document.querySelector('[data-top-paths]'),
    topEvents: document.querySelector('[data-top-events]')
  };

  const summaryFields = {
    pageviews: document.querySelector('[data-summary-pageviews]'),
    events: document.querySelector('[data-summary-events]'),
    downloads: document.querySelector('[data-summary-downloads]'),
    contacts: document.querySelector('[data-summary-contacts]'),
    visitors: document.querySelector('[data-summary-visitors]')
  };

  const outputs = {
    stats: document.querySelector('[data-admin-stats]'),
    events: document.querySelector('[data-admin-events]'),
    pageviews: document.querySelector('[data-admin-pageviews]'),
    downloads: document.querySelector('[data-admin-downloads]'),
    contacts: document.querySelector('[data-admin-contacts]')
  };

  const buttons = {
    stats: document.querySelector('[data-admin-load-stats]'),
    events: document.querySelector('[data-admin-load-events]'),
    pageviews: document.querySelector('[data-admin-load-pageviews]'),
    downloads: document.querySelector('[data-admin-load-downloads]'),
    contacts: document.querySelector('[data-admin-load-contacts]')
  };

  const setStatus = (message, tone = 'info') => {
    if (!(statusBox instanceof HTMLElement)) return;
    statusBox.hidden = false;
    statusBox.dataset.tone = tone;
    statusBox.textContent = message;
  };

  const clearStatus = () => {
    if (!(statusBox instanceof HTMLElement)) return;
    statusBox.hidden = true;
    statusBox.textContent = '';
    delete statusBox.dataset.tone;
  };

  const setOutput = (key, data) => {
    const node = outputs[key];
    if (!(node instanceof HTMLElement)) return;
    node.textContent = JSON.stringify(data, null, 2);
  };

  const clearNode = (node) => {
    while (node.firstChild) {
      node.removeChild(node.firstChild);
    }
  };

  const readNumber = (input, fallback, min, max) => {
    if (!(input instanceof HTMLInputElement)) return fallback;
    const parsed = Number.parseInt(input.value, 10);
    if (!Number.isFinite(parsed)) return fallback;
    return Math.max(min, Math.min(max, parsed));
  };

  const getBaseUrl = () => {
    if (!(apiInput instanceof HTMLInputElement)) return '';
    return apiInput.value.trim().replace(/\/$/, '');
  };

  const getToken = () => {
    if (!(tokenInput instanceof HTMLInputElement)) return '';
    return tokenInput.value.trim();
  };

  const setLoading = (loading) => {
    for (const button of Object.values(buttons)) {
      if (button instanceof HTMLButtonElement) {
        button.disabled = loading;
        if (loading) {
          button.setAttribute('aria-busy', 'true');
        } else {
          button.removeAttribute('aria-busy');
        }
      }
    }
  };

  const appendEmptyItem = (node, text) => {
    const li = document.createElement('li');
    li.className = 'admin-empty-item';
    li.textContent = text;
    node.appendChild(li);
  };

  const createBarItem = (label, total, maxTotal) => {
    const width = maxTotal > 0 ? Math.max(4, (total / maxTotal) * 100) : 0;

    const li = document.createElement('li');
    li.className = 'admin-bar-item';

    const labelSpan = document.createElement('span');
    labelSpan.className = 'admin-bar-label';
    labelSpan.textContent = label;

    const track = document.createElement('div');
    track.className = 'admin-bar-track';

    const fill = document.createElement('span');
    fill.className = 'admin-bar-fill';
    fill.style.width = `${width}%`;

    const valueSpan = document.createElement('span');
    valueSpan.className = 'admin-bar-value';
    valueSpan.textContent = String(total);

    track.appendChild(fill);
    li.appendChild(labelSpan);
    li.appendChild(track);
    li.appendChild(valueSpan);
    return li;
  };

  const renderSeries = (node, items, labelKey = 'day') => {
    if (!(node instanceof HTMLElement)) return;
    clearNode(node);
    if (!Array.isArray(items) || items.length === 0) {
      appendEmptyItem(node, 'Brak danych');
      return;
    }

    const maxTotal = items.reduce((max, item) => Math.max(max, Number(item?.total ?? 0)), 0);
    for (const item of items) {
      const label = String(item?.[labelKey] ?? '-');
      const total = Number(item?.total ?? 0);
      node.appendChild(createBarItem(label, total, maxTotal));
    }
  };

  const renderTopList = (node, items, labelKey) => {
    if (!(node instanceof HTMLElement)) return;
    clearNode(node);
    if (!Array.isArray(items) || items.length === 0) {
      appendEmptyItem(node, 'Brak danych');
      return;
    }

    const sliced = items.slice(0, 12);
    const maxTotal = sliced.reduce((max, item) => Math.max(max, Number(item?.total ?? 0)), 0);
    for (const item of sliced) {
      const label = String(item?.[labelKey] ?? '-');
      const total = Number(item?.total ?? 0);
      node.appendChild(createBarItem(label, total, maxTotal));
    }
  };

  const renderRecentEvents = (items) => {
    if (!(recentEventsWrap instanceof HTMLElement) || !(recentEventsBody instanceof HTMLElement)) return;
    recentEventsWrap.hidden = false;
    clearNode(recentEventsBody);

    if (!Array.isArray(items) || items.length === 0) {
      if (recentEventsEmpty instanceof HTMLElement) recentEventsEmpty.hidden = false;
      return;
    }
    if (recentEventsEmpty instanceof HTMLElement) recentEventsEmpty.hidden = true;

    for (const row of items.slice(0, 30)) {
      const tr = document.createElement('tr');

      const tdCreatedAt = document.createElement('td');
      tdCreatedAt.textContent = String(row?.createdAt ?? '-');
      tr.appendChild(tdCreatedAt);

      const tdEvent = document.createElement('td');
      tdEvent.textContent = String(row?.event ?? '-');
      tr.appendChild(tdEvent);

      const tdStatus = document.createElement('td');
      tdStatus.textContent = String(row?.status ?? '-');
      tr.appendChild(tdStatus);

      const tdPath = document.createElement('td');
      tdPath.textContent = String(row?.path ?? '-');
      tr.appendChild(tdPath);

      recentEventsBody.appendChild(tr);
    }
  };

  const renderDownloadsTable = (items) => {
    if (!(downloadsTableWrap instanceof HTMLElement) || !(downloadsTableBody instanceof HTMLElement)) return;
    downloadsTableWrap.hidden = false;
    clearNode(downloadsTableBody);

    if (!Array.isArray(items) || items.length === 0) {
      if (downloadsTableEmpty instanceof HTMLElement) downloadsTableEmpty.hidden = false;
      return;
    }
    if (downloadsTableEmpty instanceof HTMLElement) downloadsTableEmpty.hidden = true;

    for (const row of items) {
      const tr = document.createElement('tr');

      const tdCreatedAt = document.createElement('td');
      tdCreatedAt.textContent = String(row?.createdAt ?? '-');
      tr.appendChild(tdCreatedAt);

      const tdName = document.createElement('td');
      const fullName = [row?.firstName ?? '', row?.lastName ?? ''].join(' ').trim();
      tdName.textContent = fullName || '-';
      tr.appendChild(tdName);

      const tdEmail = document.createElement('td');
      tdEmail.textContent = String(row?.email ?? '-');
      tr.appendChild(tdEmail);

      const tdPurposes = document.createElement('td');
      const purposes = Array.isArray(row?.purposes) ? row.purposes.join(', ') : '';
      const purposeOther =
        typeof row?.purposeOther === 'string' && row.purposeOther.trim().length > 0 ? `; inne: ${row.purposeOther}` : '';
      tdPurposes.textContent = `${purposes}${purposeOther}` || '-';
      tr.appendChild(tdPurposes);

      const tdAffiliations = document.createElement('td');
      const affiliations = Array.isArray(row?.affiliations) ? row.affiliations.join(', ') : '';
      const institutionOther =
        typeof row?.institutionOther === 'string' && row.institutionOther.trim().length > 0
          ? `; instytucja: ${row.institutionOther}`
          : '';
      tdAffiliations.textContent = `${affiliations}${institutionOther}` || '-';
      tr.appendChild(tdAffiliations);

      const tdConsents = document.createElement('td');
      const terms = row?.consentTerms ? 'terms: yes' : 'terms: no';
      const updates = row?.consentUpdates ? 'updates: yes' : 'updates: no';
      const stats = row?.consentStats ? 'stats: yes' : 'stats: no';
      tdConsents.textContent = `${terms}, ${updates}, ${stats}`;
      tr.appendChild(tdConsents);

      downloadsTableBody.appendChild(tr);
    }
  };

  const fetchAdmin = async (path) => {
    const base = getBaseUrl();
    const token = getToken();

    if (!base) {
      throw new Error('Brak API base. Ustaw adres Workera.');
    }
    if (!token) {
      throw new Error('Brak admin tokenu.');
    }

    sessionStorage.setItem(STORAGE_API, base);

    const response = await fetch(`${base}${path}`, {
      method: 'GET',
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    let body = null;
    try {
      body = await response.json();
    } catch {
      body = null;
    }

    if (!response.ok) {
      const msg =
        body && typeof body === 'object' && 'message' in body && typeof body.message === 'string'
          ? body.message
          : `Request failed: ${response.status}`;
      throw new Error(msg);
    }

    return body;
  };

  const loadStats = async () => {
    const days = readNumber(daysInput, 30, 1, 365);
    const limit = readNumber(limitInput, 30, 1, 200);

    const stats = await fetchAdmin(`/admin/stats?days=${days}`);
    const events = await fetchAdmin(`/admin/records?type=events&limit=${limit}`);
    setOutput('stats', stats);
    setOutput('events', events);

    if (summaryWrap instanceof HTMLElement) summaryWrap.hidden = false;
    if (vizWrap instanceof HTMLElement) vizWrap.hidden = false;

    if (summaryFields.pageviews) summaryFields.pageviews.textContent = String(stats?.totals?.pageviews ?? 0);
    if (summaryFields.events) summaryFields.events.textContent = String(stats?.totals?.events ?? 0);
    if (summaryFields.downloads) summaryFields.downloads.textContent = String(stats?.totals?.downloads ?? 0);
    if (summaryFields.contacts) summaryFields.contacts.textContent = String(stats?.totals?.contacts ?? 0);
    if (summaryFields.visitors) summaryFields.visitors.textContent = String(stats?.totals?.uniqueVisitors ?? 0);

    renderSeries(chartNodes.pageviews, stats?.daily?.pageviews ?? [], 'day');
    renderSeries(chartNodes.events, stats?.daily?.events ?? [], 'day');
    renderSeries(chartNodes.downloads, stats?.daily?.downloads ?? [], 'day');
    renderSeries(chartNodes.contacts, stats?.daily?.contacts ?? [], 'day');
    renderTopList(chartNodes.topPaths, stats?.topPaths ?? [], 'path');
    renderTopList(chartNodes.topEvents, stats?.topEvents ?? [], 'event');
    renderRecentEvents(events?.items ?? []);
  };

  const loadRecords = async (type) => {
    const limit = readNumber(limitInput, 30, 1, 200);
    const records = await fetchAdmin(`/admin/records?type=${encodeURIComponent(type)}&limit=${limit}`);
    if (type === 'events') {
      setOutput('events', records);
      renderRecentEvents(records?.items ?? []);
    }
    if (type === 'pageviews') setOutput('pageviews', records);
    if (type === 'downloads') {
      setOutput('downloads', records);
      renderDownloadsTable(records?.items ?? []);
    }
    if (type === 'contacts') setOutput('contacts', records);
  };

  const runAction = async (message, action) => {
    clearStatus();
    setLoading(true);
    try {
      await action();
      setStatus(message, 'ok');
    } catch (error) {
      if (error instanceof Error) {
        setStatus(error.message, 'error');
      } else {
        setStatus('Nieznany błąd.', 'error');
      }
    } finally {
      setLoading(false);
    }
  };

  if (apiInput instanceof HTMLInputElement) {
    const savedApi = sessionStorage.getItem(STORAGE_API);
    if (savedApi) apiInput.value = savedApi;
  }

  buttons.stats?.addEventListener('click', () => runAction('Pobrano statystyki i wizualizacje.', () => loadStats()));
  buttons.events?.addEventListener('click', () => runAction('Pobrano eventy lejka.', () => loadRecords('events')));
  buttons.pageviews?.addEventListener('click', () => runAction('Pobrano pageviews.', () => loadRecords('pageviews')));
  buttons.downloads?.addEventListener('click', () => runAction('Pobrano rekordy pobrań.', () => loadRecords('downloads')));
  buttons.contacts?.addEventListener('click', () => runAction('Pobrano rekordy kontaktu.', () => loadRecords('contacts')));
</script>